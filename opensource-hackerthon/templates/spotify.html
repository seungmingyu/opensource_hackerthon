<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#121212">
  <title>ğŸµ Recotify</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #121212;
      color: #ffffff;
      overflow-x: hidden;
    }

    /* í—¤ë” */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      padding: 12px 16px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: #b3b3b3;
    }

    .login-btn {
      padding: 8px 16px;
      background: #ffffff;
      color: #000;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .login-btn:hover {
      background: #f0f0f0;
      transform: scale(1.05);
    }

    .logout-btn {
      padding: 6px 14px;
      background: transparent;
      color: #d0d0d0;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .container {
      padding: 16px;
      padding-bottom: 80px;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .tab-nav::-webkit-scrollbar {
      display: none;
    }

    .tab-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      color: #e0e0e0;
      font-size: 14px;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: #ffffff;
      color: #000;
      border-color: transparent;
      font-weight: 600;
    }

    .tab-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.15);
    }

    /* íƒ­ ì»¨í…ì¸  */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .feature-card {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      text-align: center;
    }

    .feature-icon {
      font-size: 48px;
      margin-bottom: 12px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .feature-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #fff;
    }

    .feature-desc {
      font-size: 14px;
      color: #b3b3b3;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    /* ì…ë ¥ í•„ë“œ */
    .input-group {
      margin-bottom: 16px;
    }

    .input-field {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.15);
    }

    .input-field::placeholder {
      color: #999;
    }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    .btn-group {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      flex: 1;
      padding: 14px;
      background: #ffffff;
      color: #000;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn:hover:not(:disabled) {
      background: #f0f0f0;
      transform: scale(1.05);
    }

    .action-btn:active {
      transform: scale(0.95);
    }

    .action-btn:disabled {
      background: #535353;
      color: #b3b3b3;
      cursor: not-allowed;
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .action-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* ê²°ê³¼ íŒ¨ë„ */
    .result-panel {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 16px;
      margin-top: 20px;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .result-title {
      font-size: 16px;
      font-weight: 600;
    }

    .result-count {
      font-size: 12px;
      color: #ffffff;
      background: rgba(255, 255, 255, 0.15);
      padding: 4px 10px;
      border-radius: 12px;
    }

    /* ë©”íƒ€ íƒœê·¸ */
    .meta-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 16px;
    }

    .meta-tag {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 16px;
      font-size: 12px;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* íŠ¸ë™ ë¦¬ìŠ¤íŠ¸ */
    .track-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .track-list::-webkit-scrollbar {
      width: 4px;
    }

    .track-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 2px;
    }

    .track-list::-webkit-scrollbar-thumb {
      background: #ffffff;
      border-radius: 2px;
    }

    .track-item {
      display: flex;
      gap: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .track-item:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .track-item:active {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(0.98);
    }

    .track-img {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: cover;
      background: rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-artist {
      font-size: 12px;
      color: #b3b3b3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading-state {
      text-align: center;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: #b3b3b3;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .empty-text {
      font-size: 14px;
      line-height: 1.5;
    }

    /* ì„±ê³µ ë©”ì‹œì§€ */
    .success-msg {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      font-size: 13px;
      color: #ffffff;
      text-align: center;
      display: none;
    }

    .success-msg.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .success-msg a {
      color: #ffffff;
      text-decoration: underline;
      font-weight: 600;
    }

    /* ë°˜ì‘í˜• - íƒœë¸”ë¦¿ ì´ìƒ */
    @media (min-width: 768px) {
      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      .feature-card {
        padding: 32px;
      }

      .tab-nav {
        justify-content: center;
      }
    }

    /* ì• ë‹ˆë©”ì´ì…˜ ìµœì í™” */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <span>ğŸµ</span>
        <span>Recotify</span>
      </div>
      <div class="user-info">
        <span id="userGreeting"></span>
        <button class="login-btn" id="loginBtn" style="display: none;">ë¡œê·¸ì¸</button>
        <button class="logout-btn" id="logoutBtn" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="container">
    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab(0)">ğŸŒ¤ï¸ ë‚ ì”¨ ë§ì¶¤</button>
      <button class="tab-btn" onclick="switchTab(1)">ğŸ¼ ê¸°ë¶„ ì „í™˜</button>
      <button class="tab-btn" onclick="switchTab(2)">âœ¨ ë”ë³´ê¸°</button>
    </div>

    <!-- íƒ­ 1: ë‚ ì”¨ ê¸°ë°˜ ì¶”ì²œ -->
    <div class="tab-content active" id="tab1">
      <div class="feature-card">
        <div class="feature-icon">ğŸŒ¤ï¸</div>
        <div class="feature-title">ë‚ ì”¨ ê¸°ë°˜ ì¶”ì²œ</div>
        <div class="feature-desc">
          ì§€ê¸ˆ ë‚ ì”¨ì™€ ë‹¹ì‹ ì´ ìµœê·¼ì— ë“¤ì€ ê³¡ì˜<br>
          <strong>ì·¨í–¥ì„ ë¶„ì„</strong>í•´ <strong>ë‹¹ì‹ ë§Œì˜ ë§ì¶¤ ìŒì•…</strong>ì„<br>
          ì¶”ì²œí•´ë“œë ¤ìš”
        </div>
        <button class="action-btn" onclick="getWeatherRecommendation()" id="weatherBtn">
          ì¶”ì²œ ë°›ê¸°
        </button>
      </div>

      <!-- ë‚ ì”¨ ì¶”ì²œ ê²°ê³¼ -->
      <div id="weatherResult" style="display: none;">
        <div class="result-panel">
          <div class="result-header">
            <div class="result-title">ì˜¤ëŠ˜ì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</div>
            <div class="result-count" id="weatherCount">0ê³¡</div>
          </div>
          
          <div class="meta-tags" id="weatherMeta"></div>
          
          <div class="track-list" id="weatherTracks"></div>
          
          <button class="action-btn" id="weatherSaveBtn" style="margin-top: 12px;">
            ğŸ’¾ Spotifyì— ì €ì¥
          </button>
          <div class="success-msg" id="weatherSuccess"></div>
        </div>
      </div>

      <!-- ë¡œë”© ìƒíƒœ -->
      <div id="weatherLoading" style="display: none;">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <div class="loading-text">ë‚ ì”¨ ë¶„ì„ ì¤‘...</div>
        </div>
      </div>
    </div>

    <!-- íƒ­ 2: í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶”ì²œ -->
    <div class="tab-content" id="tab2">
      <div class="feature-card">
        <div class="feature-icon">ğŸ¼</div>
        <div class="feature-title">ê¸°ë¶„ ì „í™˜ ì¶”ì²œ</div>
        <div class="feature-desc">
          í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•´ì„œ<br>
          <strong>ìœ ì‚¬í•œ ë¶„ìœ„ê¸°</strong>ë¡œ ê¹Šê²Œ ë¹ ì ¸ë“¤ê±°ë‚˜<br>
          <strong>ë°˜ëŒ€ ë¶„ìœ„ê¸°</strong>ë¡œ ê¸°ë¶„ ì „í™˜í•  ìŒì•…ì„<br>
          ì°¾ì•„ë“œë ¤ìš”
        </div>
        
        <div class="input-group">
          <input 
            type="text" 
            class="input-field" 
            id="playlistName"
            placeholder="í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„ ì…ë ¥ (ì˜ˆ: ì°¨ë¶„í•œ ì¬ì¦ˆ)"
          />
        </div>
        
        <div class="btn-group">
          <button class="action-btn" onclick="getPlaylistRecommendation(false)">
            ìœ ì‚¬ ì¶”ì²œ
          </button>
          <button class="action-btn" onclick="getPlaylistRecommendation(true)">
            ë°˜ëŒ€ ì¶”ì²œ
          </button>
        </div>
      </div>

      <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶”ì²œ ê²°ê³¼ -->
      <div id="playlistResult" style="display: none;">
        <div class="result-panel">
          <div class="result-header">
            <div class="result-title">ì¶”ì²œ ê²°ê³¼</div>
            <div class="result-count" id="playlistCount">0ê³¡</div>
          </div>
          
          <div class="meta-tags" id="playlistMeta"></div>
          
          <div class="track-list" id="playlistTracks"></div>
        </div>
      </div>

      <!-- ë¡œë”© ìƒíƒœ -->
      <div id="playlistLoading" style="display: none;">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <div class="loading-text">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...</div>
        </div>
      </div>
    </div>

    <!-- íƒ­ 3: ë”ë³´ê¸° -->
    <div class="tab-content" id="tab3">
      <div class="feature-card">
        <div class="feature-icon">âœ¨</div>
        <div class="feature-title">ì¤€ë¹„ ì¤‘</div>
        <div class="feature-desc">
          ë” ë§ì€ ìŒì•… ì¶”ì²œ ê¸°ëŠ¥ì´<br>
          ê³§ ì°¾ì•„ì˜¬ ì˜ˆì •ì´ì—ìš”
        </div>
        <button class="action-btn" disabled>Coming Soon</button>
      </div>
    </div>
  </div>

  <script>
    const weatherKr = {
      'Clear': 'ë§‘ìŒ', 'Clouds': 'êµ¬ë¦„', 'Rain': 'ë¹„', 'Drizzle': 'ì´ìŠ¬ë¹„',
      'Thunderstorm': 'ë‡Œìš°', 'Snow': 'ëˆˆ', 'Mist': 'ì•ˆê°œ', 'Smoke': 'ì—°ë¬´',
      'Haze': 'ì‹¤ì•ˆê°œ', 'Dust': 'ë¨¼ì§€', 'Fog': 'ì•ˆê°œ', 'Sand': 'ëª¨ë˜ë°”ëŒ',
      'Ash': 'í™”ì‚°ì¬', 'Squall': 'ëŒí’', 'Tornado': 'í† ë„¤ì´ë„'
    };

    let weatherData = null;
    let lastfmVariant = 0;

    // íƒ­ ì „í™˜
    function switchTab(index) {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
      });
      document.querySelectorAll('.tab-content').forEach((content, i) => {
        content.classList.toggle('active', i === index);
      });
    }

    // ë¡œê·¸ì¸ ì²´í¬
    async function checkLogin() {
      try {
        const res = await fetch('/current_user');
        const data = await res.json();
        
        const greeting = document.getElementById('userGreeting');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const weatherBtn = document.getElementById('weatherBtn');
        
        if (data.logged_in) {
          greeting.textContent = `${data.name}ë‹˜`;
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'block';
          weatherBtn.disabled = false;
        } else {
          greeting.textContent = '';
          loginBtn.style.display = 'block';
          logoutBtn.style.display = 'none';
          weatherBtn.disabled = true;
        }
      } catch (err) {
        console.error('Login check error:', err);
      }
    }

    document.getElementById('loginBtn').onclick = () => window.location.href = '/login';
    document.getElementById('logoutBtn').onclick = () => window.location.href = '/logout';

    // ë‚ ì”¨ ì¶”ì²œ
    async function getWeatherRecommendation() {
      const resultDiv = document.getElementById('weatherResult');
      const loadingDiv = document.getElementById('weatherLoading');
      const weatherBtn = document.getElementById('weatherBtn');
      
      resultDiv.style.display = 'none';
      loadingDiv.style.display = 'block';
      weatherBtn.disabled = true;
      
      try {
        const res = await fetch('/recommend/weather', { credentials: 'include' });
        
        if (!res.ok) {
          throw new Error(await res.text());
        }
        
        const data = await res.json();
        weatherData = data;
        
        const weatherText = weatherKr[data.trigger.weather] || data.trigger.weather;
        const temp = Math.round(parseFloat(data.trigger.feels_like));
        const ruleKrText = data.trigger.rule_kr || data.trigger.rule;
        
        document.getElementById('weatherMeta').innerHTML = `
          <div class="meta-tag"><span>ğŸ“</span>${data.location.name}</div>
          <div class="meta-tag"><span>ğŸŒ¡ï¸</span>${temp}Â°C Â· ${weatherText}</div>
          <div class="meta-tag"><span>ğŸµ</span>${ruleKrText} ë¶„ìœ„ê¸°</div>
        `;
        
        document.getElementById('weatherCount').textContent = `${data.tracks.length}ê³¡`;
        
        document.getElementById('weatherTracks').innerHTML = data.tracks.map(t => {
          const img = t.album_image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="50" height="50"%3E%3Crect fill="%23333" width="50" height="50"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23666" font-size="20"%3EğŸµ%3C/text%3E%3C/svg%3E';
          return `
            <div class="track-item" onclick="window.open('${t.url}', '_blank')">
              <img src="${img}" class="track-img" alt="">
              <div class="track-info">
                <div class="track-name">${t.name}</div>
                <div class="track-artist">${t.artists}</div>
              </div>
            </div>
          `;
        }).join('');
        
        loadingDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        document.getElementById('weatherSuccess').classList.remove('show');
        
      } catch (err) {
        console.error('Weather recommendation error:', err);
        loadingDiv.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <div class="empty-text">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤<br>${err.message}</div>
          </div>
        `;
      } finally {
        weatherBtn.disabled = false;
      }
    }

    // ë‚ ì”¨ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì €ì¥
    document.getElementById('weatherSaveBtn').onclick = async function() {
      if (!weatherData) return;
      
      const btn = this;
      const msg = document.getElementById('weatherSuccess');
      
      btn.disabled = true;
      btn.textContent = 'ì €ì¥ ì¤‘...';
      msg.classList.remove('show');
      
      try {
        const now = new Date();
        const date = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
        const weatherText = weatherKr[weatherData.trigger.weather] || weatherData.trigger.weather;
        const temp = Math.round(parseFloat(weatherData.trigger.feels_like));
        const ruleKrText = weatherData.trigger.rule_kr || weatherData.trigger.rule;
        
        const res = await fetch('/recommend/weather/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            track_ids: weatherData.tracks.map(t => t.id),
            playlist_name: `ğŸŒ¤ï¸ ${weatherText} - ${date}`,
            description: `${temp}Â°C, ${ruleKrText} ë¶„ìœ„ê¸°ì˜ ì¶”ì²œ`
          })
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || 'ì €ì¥ ì‹¤íŒ¨');
        }
        
        const result = await res.json();
        
        msg.innerHTML = `í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰<br><a href="${result.playlist_url}" target="_blank">Spotifyì—ì„œ ë³´ê¸° â†’</a>`;
        msg.classList.add('show');
        
        btn.textContent = 'âœ“ ì €ì¥ ì™„ë£Œ!';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'ğŸ’¾ Spotifyì— ì €ì¥';
        }, 3000);
        
      } catch (err) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Spotifyì— ì €ì¥';
      }
    };

    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶”ì²œ
    async function getPlaylistRecommendation(invert) {
      const playlistName = document.getElementById('playlistName').value.trim();
      
      if (!playlistName) {
        alert('í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      const resultDiv = document.getElementById('playlistResult');
      const loadingDiv = document.getElementById('playlistLoading');
      
      resultDiv.style.display = 'none';
      loadingDiv.style.display = 'block';
      
      try {
        const res = await fetch('/lastfm/recommend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            playlist_name: playlistName,
            invert: invert,
            limit: 24,
            variant: lastfmVariant
          })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          const errorMsg = errorData.detail || `HTTP ${res.status}`;
          throw new Error(errorMsg);
        }
        
        const data = await res.json();
        lastfmVariant += 1;
        
        // íƒœê·¸ í•œê¸€ ë²ˆì—­
        const tagTranslations = {
          'acoustic': 'ì–´ì¿ ìŠ¤í‹±',
          'piano': 'í”¼ì•„ë…¸',
          'ballad': 'ë°œë¼ë“œ',
          'jazz': 'ì¬ì¦ˆ',
          'classical': 'í´ë˜ì‹',
          'ambient': 'ì•°ë¹„ì–¸íŠ¸',
          'singer-songwriter': 'ì‹±ì–´ì†¡ë¼ì´í„°',
          'indie folk': 'ì¸ë”” í¬í¬',
          'dance': 'ëŒ„ìŠ¤',
          'electronic': 'ì¼ë ‰íŠ¸ë¡œë‹‰',
          'pop': 'íŒ',
          'upbeat': 'ê²½ì¾Œí•œ',
          'energetic': 'ì—ë„ˆì œí‹±',
          'party': 'íŒŒí‹°',
          'house': 'í•˜ìš°ìŠ¤',
          'edm': 'EDM',
          'happy': 'í–‰ë³µí•œ',
          'summer': 'ì—¬ë¦„',
          'feel good': 'ê¸°ë¶„ì¢‹ì€',
          'cheerful': 'ë°ì€',
          'funk': 'í‘í¬',
          'disco': 'ë””ìŠ¤ì½”',
          'sad': 'ìŠ¬í”ˆ',
          'melancholy': 'ìš°ìš¸í•œ',
          'emotional': 'ê°ì„±ì ì¸',
          'rock': 'ë¡',
          'indie': 'ì¸ë””',
          'k-pop': 'K-POP',
          'chill': 'ì¹ ',
          'hip-hop': 'í™í•©',
          'metal': 'ë©”íƒˆ',
          'lofi': 'ë¡œíŒŒì´'
        };
        
        // ë©”íƒ€ ì •ë³´ í‘œì‹œ - ê°œë³„ íƒœê·¸ë¡œ
        let metaHtml = '';
        
        if (data.used_tags && data.used_tags.length > 0) {
          // ì‚¬ìš©ëœ íƒœê·¸ë¥¼ ê°œë³„ì ìœ¼ë¡œ í‘œì‹œ
          data.used_tags.slice(0, 5).forEach(tag => {
            const koreanTag = tagTranslations[tag.toLowerCase()] || tag;
            metaHtml += `<div class="meta-tag"><span>ğŸµ</span>${koreanTag}</div>`;
          });
        }
        
        document.getElementById('playlistMeta').innerHTML = metaHtml;
        
        document.getElementById('playlistCount').textContent = `${data.tracks.length}ê³¡`;
        
        document.getElementById('playlistTracks').innerHTML = data.tracks.map(t => {
          const img = (t.album && t.album.image) || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="50" height="50"%3E%3Crect fill="%23333" width="50" height="50"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23666" font-size="20"%3EğŸµ%3C/text%3E%3C/svg%3E';
          const artistNames = (t.artists || []).join(', ');
          const externalUrl = t.external_url || '#';
          
          return `
            <div class="track-item" onclick="window.open('${externalUrl}', '_blank')">
              <img src="${img}" class="track-img" alt="">
              <div class="track-info">
                <div class="track-name">${t.name}</div>
                <div class="track-artist">${artistNames}</div>
              </div>
            </div>
          `;
        }).join('');
        
        loadingDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        
      } catch (err) {
        console.error('Playlist recommendation error:', err);
        loadingDiv.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <div class="empty-text">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤<br>${err.message}</div>
          </div>
        `;
        setTimeout(() => {
          loadingDiv.style.display = 'none';
        }, 3000);
      }
    }

    // ì´ˆê¸°í™”
    checkLogin();
  </script>
</body>
</html>